// Vitest Snapshot v1, https://vitest.dev/guide/snapshot.html

exports[`hmr plugin transform > matches snapshot 1`] = `
"_sfc_main.__hmrId = "test-id"
__VUE_HMR_RUNTIME__.createRecord(_sfc_main.__hmrId, _sfc_main)

/** - injected by kirbyup for Vue 3 HMR - */
if (typeof __VUE_HMR_RUNTIME__ !== 'undefined' && !window.__KIRBYUP_HMR_WRAPPED__) {
  window.__KIRBYUP_HMR_WRAPPED__ = true;

  const originalRerender = __VUE_HMR_RUNTIME__.rerender;
  const originalReload = __VUE_HMR_RUNTIME__.reload;

  __VUE_HMR_RUNTIME__.rerender = function(id, newRender) {
    $_syncKirbyComponent(id);
    return originalRerender.call(this, id, newRender);
  };

  __VUE_HMR_RUNTIME__.reload = function(id, newComp) {
    const record = $_getHmrRecord(id);
    if (record) {
      $_syncKirbyComponent(id, record.initialDef);
      $_applyKirbyModifications(record.initialDef, newComp);
    }
    return originalReload.call(this, id, newComp);
  };

  function $_getHmrRecord(id) {
    // Vue 3's HMR map is not exposed, so we maintain our own parallel map
    // by wrapping createRecord to track component definitions
    if (!window.__KIRBYUP_MAP__) {
      window.__KIRBYUP_MAP__ = new Map();
      const origCreate = __VUE_HMR_RUNTIME__.createRecord;
      __VUE_HMR_RUNTIME__.createRecord = function(id, initialDef) {
        window.__KIRBYUP_MAP__.set(id, { initialDef });
        return origCreate.call(this, id, initialDef);
      };
    }
    return window.__KIRBYUP_MAP__.get(id);
  }

  function $_syncKirbyComponent(id, activeDef) {
    const pluginComponents = window.panel?.plugins?.components;
    const usedComponentDefs = window.panel?.app?.config?.globalProperties?.$root?.$options?.components;

    if (!pluginComponents || !usedComponentDefs) return;

    const record = $_getHmrRecord(id);
    if (!record) return;

    for (const componentName in pluginComponents) {
      const pluginComp = pluginComponents[componentName];

      if (pluginComp.__hmrId === id || pluginComp.__file === record.initialDef?.__file) {
        const usedDef = usedComponentDefs[componentName];

        if (usedDef && record.initialDef !== usedDef) {
          record.initialDef = usedDef;
        }

        if (activeDef && typeof activeDef.$_isSection !== 'boolean') {
          activeDef.$_isSection = /^k-.*-section$/.test(componentName);
        }

        break;
      }
    }
  }

  function $_applyKirbyModifications(activeDef, newDef) {
    const usedComponentDefs = window.panel?.app?.config?.globalProperties?.$root?.$options?.components;

    if (!usedComponentDefs) return;

    // Give templates priority over render functions
    if (newDef.template) {
      newDef.render = null;
    }

    // Re-apply section mixin for section components
    if (activeDef.$_isSection) {
      newDef.$_isSection = true;
      if (!newDef.mixins?.[0]?.methods?.load) {
        const sectionMixin = activeDef.mixins?.[0];
        if (sectionMixin) {
          newDef.mixins = [sectionMixin, ...(newDef.mixins || [])];
        }
      }
    }

    // Resolve component name in extends to definition object
    if (typeof newDef.extends === 'string') {
      if (newDef.extends === activeDef.extends?.name) {
        newDef.extends = activeDef.extends;
      } else if (usedComponentDefs[newDef.extends]) {
        newDef.extends = usedComponentDefs[newDef.extends];
      } else {
        newDef.extends = null;
      }
    }
  }
}
/** -- */

import.meta.hot.accept(mod => {})"
`;
